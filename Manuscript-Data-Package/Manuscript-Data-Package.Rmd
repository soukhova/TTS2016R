---
title: "TTS2016R: A data set to study population and employment patterns from the 2016 Transportation Tomorrow Survey (TTS) in the Greater Golden Horseshoe Area, Ontario, Canada"
author:
  - name: "Anon1"
    email: "Anon1@anon.org"
    affiliation: CODE
  - name: "Anon2"
    email: "Anon2@anon.org"
    affiliation: CODE
    footnote: 1
address:
  - code: CODE
    address: "Some school"
footnote:
  - code: 1
    text: "Corresponding Author"
abstract: 
  "This paper describes and visualises the data contained within the {TTS2016R} data package created in `R`, the statistical computing and graphics language. In addition to a synthetic example, {TTS2016R} contains home-to-work commute information for the Greater Golden Horseshoe (GGH) area in Canada retrieved from the 2016 Transportation Tomorrow Survey (TTS). Included are all Traffic Analysis Zones (TAZ), the number of people who are employed full-time per TAZ, the number of jobs per TAZ, the count of origin destination (OD) pairs and trips by mode per origin TAZ, calculated car travel time from TAZ OD centroid pairs, and associated spatial boundaries to link TAZ to the Canadian Census. To illustrate how this information can be analysed to understand patterns in commuting, we estimate a distance-decay curve (i.e., impedance function) for the region. {TTS2016R} is a growing open data product built on `R` infrastructure that allows for the immediate access of home-to-work commuting data alongside complimentary objects from different sources. The package will continue expanding with additions by the authors and the community at-large by requests in the future. {TTS2016R} can be freely explored and downloaded in the associated [Github repository](https://github.com/soukhova/TTS2016R) where the documentation and code involved in data creation, manipulation, and all open data products are detailed."
    
keywords: Jobs; population; work; commute; travel time; impedance; Greater Toronto and Hamilton Area; Greater Golden Horshoe Area, Ontario, Canada; R 
classoption:
  - Royal
  - times
bibliography: bibfile.bib
bibliographystyle: sageh
output:
  rticles::sage_article:
    keep_tex: yes
---
```{r knitr-setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  cache = TRUE,
  warning = FALSE,
  comment = '', 
  out.width = "1\\linewidth")
```

```{r install-data-package, include=FALSE}
if (!require("TTS2016R", character.only = TRUE)) {
      remotes::install_github("soukhova/TTS2016R",
                        build_vignettes = TRUE)
  }
```

```{r load-packages, include=FALSE, cache=FALSE}
library(TTS2016R)
library(dplyr)
library(fitdistrplus)
library(ggplot2)
library(kableExtra)
library(patchwork)
library(sf)
library(scales)
library(stats)
library(ggspatial)
library(shadowtext)
library(tmap)
library(ggpmisc)
# library(ggpmisc)
# library(ggrepel)
# library(cowplot)
# library(spdep)
# library(RColorBrewer)
# library(extrafont)
# font_import()
# loadfonts(device = "win")

options(scipen = 999)
```

# Introduction

This manuscript presents the open data product [{TTS2016R}](https://github.com/soukhova/TTS2016R). Open data products are the result of turning source data (open or otherwise) into accessible information that adds value to the original inputs [see @Arribas2021open]. The product presented in this paper is a `R` data package which currently consists of a fusion of objects from a variety of sources: home-to-work flows sourced from the 2016 Transportation Tomorrow Survey (TTS) [@data_management_group_tts_2018], estimated travel times (calculated using {r5r} [@Pereira2021r5r]), and boundary files from the TTS [@datamanagementgroupSurveyBoundaryFiles2018] and from the Canadian Census [@statisticscanadaBoundaryFiles20162017].

What is a `R` data package? A `R` data package contains code, data, and documentation in a standardised collection format that can be installed by `R` users through a centralized software repository such as CRAN (the Comprehensive R Archive Network) and GitHub. {TTS2016R} is freely available on GitHub for all to install and freely use in the spirit of open and reproducible research. Currently and in more detail, {TTS2016R} includes full-time home-based work-to-job origin destinations (OD) counts and mode-specific trip numbers retrieved from the 2016 TTS, traffic analysis zone (TAZ) boundaries, and municipality, planning, and census metropolitan area boundaries for the Greater Golden Horse area (GGH) located in southern Ontario, Canada. In addition, the package includes TAZ centroid-to-centroid travel times by car, transit, cycling, and walking mode computed using package {r5r} [@Pereira2021r5r]. 

The aim of this paper is to walk readers through the data sets, illustrate a use case (i.e., the calculation of an impedance function that can be used to calculate accessibility to employment), and invite others to experiment in its uses and applications. Though data from the TTS is freely available to the public through the [TTS Data Retrieval System](https://dmg.utoronto.ca/idrs/index), the raw data can be technically demanding, cumbersome to work with, and requires multiple software to process. By pre-processing the data, packaging it with complimentary data, and providing explicit documentation in a `R` environment, {TTS2016R} offers a slice of the TTS data that can be immediately used by `R` users to analysis patterns of commuting to work in the region. Anticipate this package to grow in the future: it currently provides an open infrastructure for additional TTS or complimentary data sets to be amended by the authors and the open-source community in the future by request.

# Home-to-work commute data
<!-- NOTE: When extracting trip vs. person data in the TTS database. For 'by person' extraction: Trips made by person include all trips. For 'by trip' extraction: trips made do not include walking trips to non-school or non-work purposes, so the total number of trips extracted through this method is NOT equal to the total number of trips per person (the total number of trips per person is always higher than the total number of trips). You can't filter the 'by person' extraction by trip purpose. You can filter the 'by trip' extraction by trip purpose, so we will be using the 'by trip' extraction - filtered by 'home-based work' - to get the primary mode trip numbers. -->
Currently, {TTS2016R} includes counts of full-time employed population by place of residence (origin), counts of full-time usual place of work (destination), number of trips to work by mode, and the calculated potential travel time of the trips in the GGH. The GGH (and hence the TTS survey area) is displayed in Figure \ref{fig:TTS-16-survey-area}.

This data is aggregated and available at the level of TAZ: TAZ are a spatial unit of analysis typically used to estimate the number of trips produced and attracted to each zone [@meyer_urban_2001]. They are thus defined by transportation planners for a region based on intra-similarity and inter-dissimilarity between land-use and population demographics. Within the GGH boundaries, `r round(length(TTS2016R::ggh_taz$GTA06), 3) %>% prettyNum(big.mark = ",")` TAZ are specified and each TAZ is uniquely identified using the GTA06 Zoning System: the survey boundary is discussed in the 2016 TTS methodology and defined by the TTS [@data_management_group_tts_2018].  The TAZ range between $\ge$ 0.019 km^2^ in spatial area to a maximum of `r max(TTS2016R::ggh_taz$AREA) %>% prettyNum(digits =2, big.mark = ",")` km^2^ (median: `r median(TTS2016R::ggh_taz$AREA) %>% prettyNum(digits =2, big.mark = ",")` km^2^ and 3rd quantile: `r quantile(TTS2016R::ggh_taz$AREA, probs=0.75) %>% unname() %>% prettyNum(digits =2, big.mark = ",")` km^2^). 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# grouping the planning boundaries/municipalities so they make up the 20 regions in the TTS 2016. Note: st_buffer is used as there are small existing gaps between some boundaries. st_buffer of 10 m is enough to widen all boundaries and complete the st_union without issue.
group_ggh_pd_poly <- TTS2016R::ggh_pd %>% st_buffer(10) %>% group_by(REGION) %>% 
  summarize(REGION_name = first(REGION_name),
            geometry = st_union((geometry)))

# creating an object of centroids for each region - this will be used to label polygons on the map
group_ggh_pd <- sf::st_centroid(group_ggh_pd_poly) 
points <- sf::st_coordinates(group_ggh_pd) %>% data.frame() 
group_ggh_pd <- cbind(group_ggh_pd, points)

## manually readjusting the X and Y coordinate of "County of Peterborough" and "Brant" as the resulting label overlap some city's names on the map.
group_ggh_pd[group_ggh_pd$REGION_name=="Brant", "X"] <- 544000.0
group_ggh_pd[group_ggh_pd$REGION_name=="Brant", "Y"] <- 4767466

group_ggh_pd[group_ggh_pd$REGION_name=="Peterborough County", "Y"] <- 4921000
```
```{r, echo=FALSE, message=FALSE, warning=FALSE, include = FALSE}
#plot 
TTS_area_plot <- ggplot() +
  geom_sf(data = TTS2016R::ggh_pd, color = "darkgray",
          aes(fill = REGION_name)) +
  scale_fill_manual(values = viridis::viridis(20)) +
  geom_sf(data = group_ggh_pd_poly, 
          color = "black", fill = NA, size = 0.7) +
  annotation_north_arrow(location = "tl", # north arrow for both the main plot
                         height = unit(0.8, "cm"), 
                         width = unit(0.8, "cm"),
                         style = north_arrow_orienteering(line_width = 0.25,
                                                          line_col = "dimgrey", 
                                                          fill = c("white","dimgrey"))) +
  annotation_scale(bar_cols = c("dimgrey", "white"), # scale bar for both the main plot
                   height = unit(0.15, "cm")) + 
  geom_shadowtext(data = group_ggh_pd,
                  aes(x = X, y = Y, label = REGION_name),
                  size = 3,
                  nudge_y = 3000,
                  nudge_x = 2000) +
  theme_void() +
  theme(legend.position = "none",
        axis.title = element_blank()) 
# ggsave("images/TTS16-survey-area.png")
```
```{r creating-desc-stats-table-edits}
od <- od %>% mutate(travel_time = ifelse(Origin == Destination, 10, travel_time),
              travel_time = ifelse(travel_time == 0, NA, travel_time))
```
```{r creating-desc-stats-table}
#forming a complete descriptive statistic table
Statistics <- data.frame("Statistic" = c("Min.", "1st Qu.", "Median", "Mean", "3rd Qu.", "Max.", "NA's"))

Links <- data.frame("Links" = c(summary(od$Persons)[[1]] %>% round(), 
                                   summary(od$Persons)[[2]] %>% round(),  
                                   summary(od$Persons)[[3]] %>% round(), 
                                   summary(od$Persons)[[4]] %>% round(), 
                                   summary(od$Persons)[[5]] %>% round(),
                                   summary(od$Persons)[[6]]%>% round(),
                                   NA))
# 
# Trips <- data.frame("Trips" = c(summary(od$sum_trips)[[1]] %>% round(), 
#                                    summary(od$sum_trips)[[2]] %>% round(),  
#                                    summary(od$sum_trips)[[3]] %>% round(), 
#                                    summary(od$sum_trips)[[4]] %>% round(), 
#                                    summary(od$sum_trips)[[5]] %>% round(),
#                                    summary(od$sum_trips)[[6]]%>% round(),
#                                    NA))

Travel_time <- data.frame("TT" = c(summary(od$travel_time)[[1]] %>% round(), 
                                               summary(od$travel_time)[[2]] %>% round(),  
                                               summary(od$travel_time)[[3]] %>% round(), 
                                               summary(od$travel_time)[[4]] %>% round(), 
                                               summary(od$travel_time)[[5]] %>% round(), 
                                               summary(od$travel_time)[[6]] %>% round(),  
                                               3507)) 

# TAZ_Area <- data.frame("TAZ_Area" = c(summary(ggh_taz$AREA)[[1]] %>% round(1), 
#                                       summary(ggh_taz$AREA)[[2]] %>% round(1), 
#                                       summary(ggh_taz$AREA)[[3]] %>% round(1), 
#                                       summary(ggh_taz$AREA)[[4]] %>% round(1), 
#                                       summary(ggh_taz$AREA)[[5]] %>% round(1), 
#                                       summary(ggh_taz$AREA)[[6]] %>% round(1), 
#                                       NA))

Workers <- data.frame("Workers" = c(summary(ggh_taz$workers)[[1]] %>% round(), 
                                    summary(ggh_taz$workers)[[2]] %>% round(), 
                                    summary(ggh_taz$workers)[[3]] %>% round(), 
                                    summary(ggh_taz$workers)[[4]] %>% round(), 
                                    summary(ggh_taz$workers)[[5]] %>% round(), 
                                    summary(ggh_taz$workers)[[6]] %>% round(), 
                                    NA))

Jobs <- data.frame("Jobs" = c(summary(ggh_taz$jobs)[[1]] %>% round(), 
                              summary(ggh_taz$jobs)[[2]] %>% round(), 
                              summary(ggh_taz$jobs)[[3]] %>% round(), 
                              summary(ggh_taz$jobs)[[4]] %>% round(), 
                              summary(ggh_taz$jobs)[[5]] %>% round(), 
                              summary(ggh_taz$jobs)[[6]] %>% round(), 
                              NA)) 

desc_stats <- cbind(Statistics, Workers, Jobs, Links, Travel_time)

# #kable tabling 
# desc_stats %>%
#   kable(format = "latex",
#         align="lrrrrrr",
#         booktabs = T,
#         col.names = c(" ", "(#)", "(min)", "(km^2)", "(#)", "(#)"),
#         caption = "\\label{tab:TTS-16-desc-stats}Descriptive statistics of the trips, calculated origin-destination car travel time, TAZ area, workers per TAZ, and jobs per TAZ.") %>%
#   add_header_above(c(" ", "Trips", "Travel Time", "Area", "Workers", "Jobs"), align = "r")%>%
#   kable_styling(full_width = "T", 
#                 latex_options = c("scale_down"),
#                 position = "center")
```
```{r, TTS-16-survey-area, echo=FALSE, fig.cap="\\label{fig:TTS-16-survey-area}TTS 2016 study area within the GGH in Ontario, Canada along with associated descriptive statistic of workers and jobs per TAZ, OD links (count of workers potentially interacting with their place of employment) by origin TAZ, and calculated OD car travel time (TT) per origin TAZ. 3,507 trips were not assigned TT as they are longer than 180 mins. Spatial boundary files are retrieved from the TTS which define the survey area (Data Management Group, 2018a): the 20 regions in the GGH are represented by black lines and labelled, the dark gray lines are planning boundaries.", out.width="100%", fig.align = 'center', fig.pos='H', message=FALSE, warning=FALSE}
TTS_area_plot <- TTS_area_plot + annotate(geom = "table",
            x = 915000, y = 4880000, 
           label = list(desc_stats))
ggsave("images/TTS16-survey-area.png")
knitr::include_graphics("images/TTS16-survey-area.png")
```

## Full-time employed people and associated places of employment

In the GGH, there are `r round(sum(TTS2016R::ggh_taz$workers), 3) %>% prettyNum(big.mark = ",")` workers, `r round(sum(TTS2016R::ggh_taz$jobs), 3) %>% prettyNum(big.mark = ",")` jobs, and `r TTS2016R::od$sum_trips %>% sum()%>% prettyNum(big.mark = ",")` work-related trips (for the 2016 TTS survey day).  The values are organized within the origin destination (OD) table in the {TTS2016R} package and are derived from the cross-tabulation by person and by trip for the full-time employed population and associated places of employment. 

Additionally, the total number of full-time workers and jobs in the TTS 2016 region are not equal. Since the outer boundaries of the TTS are permeable, workers who reside within the boundaries but have workplaces that are outside of the boundaries are counted as workers within an origin TAZ, while jobs in TAZ that are filled by workers who reside outside the GGH boundaries are _unknown_ since they were not surveyed. This mismatch results in the total number of workers being `r round(sum(ggh_taz$workers)/sum(ggh_taz$jobs),2)` times larger than the number of jobs. The TTS is a proportionally representative survey, hence the values included in {TTS2016R} are adjusted to reflect the GGH working population and their home-based trips to places of GGH employment.

The count of links and trips made by the full-time working population and associated full-time place of employment per unique OD pair are quite variable. TAZ contain between `r min(TTS2016R::ggh_taz$workers) %>% prettyNum(digits =2, big.mark = ",")` to `r max(TTS2016R::ggh_taz$workers) %>% prettyNum(digits =2, big.mark = ",")` workers (median: `r median(TTS2016R::ggh_taz$workers) %>% prettyNum(digits =2, big.mark = ",")`, 3rd quantile: `r quantile(TTS2016R::ggh_taz$workers, probs=0.75) %>% unname() %>% prettyNum(digits =2, big.mark = ",")`), `r min(TTS2016R::ggh_taz$jobs) %>% prettyNum(digits =2, big.mark = ",")` to `r max(TTS2016R::ggh_taz$jobs) %>% prettyNum(digits =2, big.mark = ",")` jobs (median: `r median(TTS2016R::ggh_taz$jobs) %>% prettyNum(digits =2, big.mark = ",")`, 3rd quantile: `r quantile(TTS2016R::ggh_taz$jobs, probs=0.75) %>% unname() %>% prettyNum(digits =2, big.mark = ",")`), and generate between 0 to 241 trips (median: 15, 3rd quantile: 42).
```{r, include=FALSE, eval=FALSE, echo=FALSE}
#counting the number of trips per origin TAZ.
t <- od %>% group_by(Origin) %>% summarize(count = n()) %>%
  merge(ggh_taz %>% st_drop_geometry(), by.x=c("Origin"), by.y =c("GTA06"), all.y=TRUE) %>%
  mutate(count = ifelse(is.na(count), 0, count))
t$count %>% summary()
```

```{r tts-workers-jobs-plot, fig.cap="\\label{fig:tts-workers-jobs-plot}Number of workers (left) and jobs (right) in each TAZ retrieved from the 2016 TTS (Data Management Group, 2018b). Spatial boundary files are retrieved from the TAZ defined by the TTS (Data Management Group, 2018a).", fig.width=8, fig.height=5}

tts_workers <- tm_shape(ggh_taz) +
  tm_fill(col = "workers", title = "Full-time \nemployed people", palette = "YlGnBu", alpha = 0.8, style = "jenks") +
  tm_compass(type = "arrow", position = c("left", "top"), size = 2) +
  tm_scale_bar(breaks = c(0, 30, 60), text.size = 0.5, position = c("left", "bottom")) +
  tm_layout(legend.position = c("right", "bottom"))

tts_jobs <- tm_shape(ggh_taz) +
  tm_fill(col = "jobs", title = "Full-time \njobs", palette = "YlGnBu", alpha = 0.8, style = "jenks") +
  tm_compass(type = "arrow", position = c("left", "top"), size = 2) +
  tm_scale_bar(breaks = c(0, 30, 60), text.size = 0.5, position = c("left", "bottom")) +
  tm_layout(legend.position = c("right", "bottom"))

tmap_arrange(tts_workers, tts_jobs)

```
<!--
```{r ECD-plot, fig.cap="\\label{fig:ECD-plot}The cumulative distribution of the number of jobs and workers per TAZ from the 2016 TTS data set. Light blue shaded ranges correspond to all cumulative proabilities where the number of workers per TAZ are larger than jobs per TAZ.", fig.width=8, fig.height=4}

Number <- rbind(ggh_taz$jobs %>% data.frame(),
                 ggh_taz$workers %>% data.frame())
Group <- rbind(rep("Jobs", each=length(ggh_taz$jobs)) %>% data.frame(),
                rep("Workers", each=length(ggh_taz$workers))%>% data.frame())

ecdf_data <- cbind(Number, Group)
colnames(ecdf_data) <- c("Number", "Group")

rect1 <- data.frame(xmin=115, xmax=3055, ymin=-Inf, ymax=Inf)
  
ggplot(ecdf_data , aes(x=Number, col=Group)) + 
  # geom_segment(aes(x = 115, y = 0, xend = 115, yend = 0.34), col = "blue", linetype=2) +
  # geom_segment(aes(x = 3055, y = 0, xend = 3055, yend = 0.94), col = "blue", linetype=2) +
  geom_rect(data = rect1, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill="lightblue", alpha=0.2, inherit.aes = FALSE) +
  stat_ecdf() + 
  scale_x_continuous(trans='sqrt', breaks=c(115, 3055, 10000, 20000, 30000, 40000)) + 
  scale_y_continuous(breaks=c(0, 0.25,0.34, .50, .75,0.94, 1.00)) +
  labs(x = "Opportunities per TAZ",
       y = "Cumulative probability") + 
      scale_color_manual("Opportunities", 
                         values = c("Jobs" = "Black",
                                    "Workers" = "Red"))+
  scale_linetype_manual("Opportunities",values=c(0,1)) +
  geom_point(aes(x = 115, y = 0.34), col = "blue")+
  geom_point(aes(x=3055, y=0.94), col = "blue") +
  theme_minimal() +
  theme(plot.title = element_text(hjust=0.5),
        legend.position = c(0.90,0.75),
        axis.line = element_line(colour = "black"),
        panel.border = element_blank()) 
```
-->
Figure \ref{fig:tts-workers-jobs-plot} presents the number of employed people and associated jobs per TAZ. It can be observed that the spatial distribution of jobs and workers is unequal, which is indicative of a jobs -housing imbalance that can impact accessibility in a region [@Levine1998rethinking]. Also, there is a higher number of TAZ with no workers than zones with no jobs (i.e., `r ggh_taz %>% st_drop_geometry() %>% count(workers) %>% filter(workers == 0) %>% pull('n')` TAZ with no workers and `r ggh_taz %>% st_drop_geometry() %>% count(jobs) %>% filter(jobs == 0) %>% pull('n')` TAZ with no jobs) and the mean of workers per TAZ is higher than the mean of jobs. The number TAZ with an extreme number of jobs at the highest and lowest percentiles is significantly higher than the number of workers. <!-- see the following cumulative probability distribution in Figure \ref{fig:ECD-plot}. --> <!-- Workers are concentrated in TAZ within the center of the GGH and along the south-east and northern boarder of the GGH. The center of the GGH corresponds to the Greater Toronto Area (GTA) which is the most densely populated area in southern Ontario [@statistics_canada_daily_2022]. The south east border of the GGH neighbours Lake Ontario and is delineated by the urban built boundary of the Ontario Growth Plan being home to the highest density of working population in the GGH [@ontario_built_2019;@auditor_general_of_ontario_value_2021]. The northern GGH border corresponds to the Simcoe, Dufferin, Kawartha Lake, and Peterborough regions which are home to lower density of worker population density population [@auditor_general_of_ontario_value_2021]. Conversely, the spread of jobs in the GGH is lower than the number of workers indicating population is more spatially dispersed than jobs. --> <!--- in which the 94th to 100th percentile and the 0th to 34th percentile of jobs in TAZ is higher than the number of workers in TAZ. This means that between these ranges, TAZ have a higher number of workers than they do jobs, echoing the more even spatial distribution of workers observed in Figure \ref{fig:tts-workers-jobs-plot}. -->

## Calculated travel time

Also included in {TTS2016R} are the estimated travel times between OD as summarized in the descriptive statistics table in Figure \ref{fig:plot-tt-ttpertrip}; travel times are calculated using the package {r5r}. {r5r} interfaces with the java-based R5 routing engine developed separately by Conveyal [@conveyalConveyalR5Routing2022]. The inputs to {r5r} for this data package were: the desired mode, a maximum travel time threshold of 180 minutes, the geo-coded origin destination pairs based on the centroids of the TAZ, and the static OpenStreetMap road network of Ontario (retrieved using Geofabrick [@geofabrikOntarioOpenStreetMapGeofabrik2022]). A travel time threshold of 180 minutes was selected since it captures almost all potential OD interactions. 

Additionally, car travel is included in this data package because it is a critically important commute mode in the GGH. `r sum(od$C_DPC, od$C_PPC, od$C_RS, od$C_SB, od$C_TA) %>% prettyNum(big.mark = ",")` of the trips are made using a car out of the total `r sum(od$sum_trips) %>% prettyNum(big.mark = ",")` work-related trips according to the TTS 2016 data  (i.e., `r (sum(od$C_DPC, od$C_PPC, od$C_RS, od$C_SB, od$C_TA) / sum(od$sum_trips)) %>% percent()` of trips are taken by car).

These travel times are a useful addition to {TTS2016R} since they are not included in the [TTS Data Retrieval System](https://dmg.utoronto.ca/idrs/index) but they are vitally important to estimate the cost of travel and associated impedance functions, among other possible applications. If the readership is interested in additional information regarding the travel time computation, please see the calculation notebook in the documentation of {TTS2016R} and details about {r5r} at the [r5r package website](https://ipeagit.github.io/r5r/index.html).
```{r data-for-impedance}
# remove all NA trips from dataset and set all 0min travel times to 0.1 min
od  <- TTS2016R::od %>% 
  filter( !is.na(travel_time)) %>% 
  mutate(travel_time = ifelse(travel_time == 0, 0.1, travel_time))

all_tt <- od  %>% 
  dplyr::select(Persons, travel_time)

all_tt <- all_tt[rep(seq_len(dim(all_tt)[1]), all_tt$Persons), 2]
```

```{r fitting-impedance}
#fitting impedance function
gamma_ <- fitdistrplus::fitdist(data=all_tt, "gamma", method="mle", optim.method="Nelder-Mead") 
```

```{r calc-for-accessibility-GGH}
# transfer calibrated impedance function values to OD matrix
od <- od %>%
  mutate(f = dgamma(travel_time, gamma_$estimate["shape"], gamma_$estimate["rate"]))

#add the number of jobs and workers to the od matrix
od_ft <- od %>% merge(ggh_taz %>% dplyr::select(GTA06, workers) %>% st_drop_geometry(),
                   by.x = "Origin", by.y="GTA06", all.x = TRUE)

od_ft <- od_ft %>% merge(ggh_taz %>% dplyr::select(GTA06, jobs) %>% st_drop_geometry(),
                   by.x = "Destination", by.y="GTA06", all.x = TRUE)


#calculate accessibility for workers from any origin to jobs in Toronto 
GGH_c_accessibility <- od_ft %>% 
  mutate(GGH_A_ij = f * jobs) %>%
  group_by(Origin) %>%
  summarise(GGH_A_i = sum(GGH_A_ij, na.rm = T),
            GGH_sum_tt_i = sum(travel_time),
            GGH_tt_trips_i = mean(travel_time),
            GGH_sum_f_i = sum(f),
            GGH_f_trips_i = mean(f))

#Merge TO accessibly calculation to the ggh_taz:
GGH_taz_acc <- ggh_taz %>% merge(GGH_c_accessibility, by.x=c("GTA06"), by.y=c("Origin"), all.x=T) 
```

```{r plot-tt-ttpertrip, fig.cap="\\label{fig:plot-tt-ttpertrip}Calculated total worker travel time by car (left) and average worker travel time by car (right) for each TAZ in the 2016 TTS. Car travel times calculated using {r5r} (Pereira et al., 2021). Planning boundaries of Niagara and Waterloo (Data Management Group, 2018a), and the Toronto census metropolitan area (Statistics Canada, 2017) are drawn with purple, brown and blue borders, respectively. ", fig.width=8, fig.height=5, message=FALSE}
tts_total_tt <- tm_shape(GGH_taz_acc) +
  tm_fill(col = "GGH_sum_tt_i", title = "Total travel time\n per TAZ (min)", palette = "-Spectral", alpha=0.85, style = "jenks") +
  tm_shape(ggh_pd %>% filter(REGION_name == "Niagara")) +
  tm_borders(col="Purple")+
  tm_shape(ggh_pd %>% filter(REGION_name == "Waterloo")) +
  tm_borders(col="Brown")+
  tm_shape(ggh_cma %>% filter(CMANAME == "Toronto")) +
  tm_borders(col="Blue")+
  tm_compass(type = "arrow", position = c("left", "top"), size = 2) +
  tm_scale_bar(breaks = c(0, 30, 60), text.size = 0.5, position = c("left", "bottom")) +
  tm_layout(legend.position = c("right", "bottom"))

tts_tt_per_trip <- tm_shape(GGH_taz_acc) +
  tm_fill(col = "GGH_tt_trips_i", title = "Avg. travel time\n per TAZ (min)", palette = "-Spectral", alpha = 0.85, style = "jenks") +
  tm_shape(ggh_pd %>% filter(REGION_name == "Niagara")) +
  tm_borders(col="Purple")+
  tm_shape(ggh_pd %>% filter(REGION_name == "Waterloo")) +
  tm_borders(col="Brown")+
  tm_shape(ggh_cma %>% filter(CMANAME == "Toronto")) +
  tm_borders(col="Blue")+
  tm_compass(type = "arrow", position = c("left", "top"), size = 2) +
  tm_scale_bar(breaks = c(0, 30, 60), text.size = 0.5, position = c("left", "bottom")) +
  tm_layout(legend.position = c("right", "bottom"))

tmap_arrange(tts_total_tt, tts_tt_per_trip)
```
\newpage

As can be observed in Figure \ref{fig:plot-tt-ttpertrip}, the total travel time resembles the spatial trend distribution in the number of employed people in the previous plot (Figure \ref{fig:tts-workers-jobs-plot}) and the spatial distribution of the average travel time is distinct from other plots presented so far. For instance, we can see that in areas around the south-eastern border such as Niagara and Waterloo (purple and brown borders), the average travel times are moderately low. Additionally, travel times (by car) within the core of the Toronto census metropolitan area (CMA) (blue) is also moderately low since traffic congestion is not reflected in the travel time calculations. Further from these areas, travel times are higher.

## Calibrating an impedance function

An application of the {TTS2016R} package is the calculation of an impedance function. Impedance functions are useful to understand mobility behaviour and are used to estimate gravity models of spatial interaction [@wilson1971; @haynes_gravity_1985] and applied in accessibility analysis [@hansen_how_1959;@talen_assessing_1998;@paez_jobs_2013;@barboza_balancing_2021]. An impedance function $f(\cdot)$ depends on the cost of travel $c_{ij}$ between locations $i$ and $j$ (all which is supplied in the travel time and origin-destination table within {TTS2016R}). <!-- The impedance function is usually a monotonically decreasing function since the separation of land uses means that very short commuting trips are relatively rare. However, sometimes the function can increase to reflect patterns of separation between activities. This could be needed to reflect fluctuations in travel cost due to hierarchical patterns, where travelers bypass opportunities in favor of more distant destinations that offer economies of agglomeration. -->

A useful technique to calibrate an impedance function is to use the trip length distribution (TLD) as measured from origin-destination data [@horbachov_theoretical_2018; @batista_estimation_2019]. The TLD is the representation of the likelihood that a proportion of trips are taken at a specific travel cost. In our data set, where we assume cost is travel time, the impedance function maps low travel times to higher proportions of trips, and high travel times are mapped to low proportion of trips.

Using the data contained in {TTS2016R}, we fit the empirical TLD to a density distribution using maximum likelihood techniques and the Nelder-Mead method for direct optimization available within the `R` package {fitdistrplus} [@fitdistrplus_2015]. Based on goodness-of-fit criteria and diagnostics seen in Figure \ref{fig:TLD-Gamma-plot}, the gamma distribution is selected. The 'shape' parameter is $\alpha$ = `r round(gamma_$estimate[1], 3)`, the estimated 'rate' is $\beta$ = `r round(gamma_$estimate[2], 3)` , and $\Gamma(\alpha)$ is defined in Equation (\ref{gamma-dist}).
```{r save-impedance-plot, include=FALSE}
# For some reason plot(gamma_) does not play well with knitr, so instead we save the figure and then include it as a graphic in the following chunk
png("images/impedance_function.png")
plot(gamma_)
dev.off()
```

```{r TLD-Gamma-plot, fig.cap="\\label{fig:TLD-Gamma-plot}Empirical TTS 2016 home-based car TLD (black) and calibrated gamma distribution impedance function (red) with associated Q-Q and P-P plots", out.width="75%", fig.align='center'}
knitr::include_graphics("images/impedance_function.png")
```

\renewcommand{\[}{\begin{equation}}
\renewcommand{\]}{\end{equation}}

$$
\begin{aligned}
f(x, \alpha, \beta) = \frac {x^{\alpha-1}e^{-\frac{x}{\beta}}}{ \beta^{\alpha}\Gamma(\alpha)} \quad \text{for }	0 \leq x \leq \infty \label{gamma-dist} \\
\Gamma(\alpha) =  \int_{0}^{\infty} x^{\alpha-1}e^{-x} \,dx
\end{aligned}
$$

```{r create-cullen-frey-data}
# remove all NA trips from dataset and set all 0min travel times to 0.1min
od  <- od %>% filter( !is.na(travel_time)) %>% mutate(travel_time = ifelse(travel_time == 0, 0.1, travel_time))
all_tt <- od  %>% dplyr::select(Persons, travel_time)
all_tt <- all_tt[rep(seq_len(dim(all_tt)[1]), all_tt$Persons), 2]
```
<!-- # ```{r plot-cullen-frey, message = FALSE, fig.height=6, fig.cap="\\label{fig:plot-cullen-frey}Cullen and frey graphy for the 2016 TTS calculated travel times."} -->
<!-- # fitdistrplus::descdist(data=all_tt)  -->
<!-- # ``` -->

# Concluding remarks

This paper introduces {TTS2016R}, an open data product in the form of a `R` data package. This package is a fusion of data from multiple sources and we demonstrate the spatial and numeric extent of the data contained within. It includes an OD cross-tabulation by person and by trip mode table for home-to-work commute data from the 2016 TTS alongside complimentary boundaries and estimated travel times.  The value of this data package is in its transparency, easy of access, and its open infrastructure for the addition of complimentary data sets in the future. `R` users can immediately and easily explore GGH commute flow trends as well as suggestion further amendments to the package by request. One possible use of this data, as showcased in this paper, is the calibration of impedance functions which in turn can be used for accessibility analysis.

<!-- New digital formats are increasingly complex and the explanation of the methods often do not concisely and intelligibly fit within the confines of a traditional article. With this motivation, we invite all who are interested to use {TTS2016R} to explore the worker-employment patterns contained in the {TTS2016R} package. --> In the spirit of novel and original research, we hope readers value the efforts made to detail the data in order to improve transparency in our work and encourage others to replicate and, hopefully, inspire research of their own. We see this product as providing open infrastructure for additional TTS or complimentary data sets to be amended by the authors or wider open-source community in the future. 

# References {#references .unnumbered}
